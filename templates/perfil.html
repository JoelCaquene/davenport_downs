{% extends "base.html" %}
{% load static %}

{% block title %}Meu Perfil{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1>Meu Perfil</h1>
    </div>

    {% if messages %}
        <ul class="messages">
            {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}
    
    {# Exibir apenas o Número de Telefone no topo, acima dos botões de acesso #}
    <div class="top-info-phone">
        <span class="label">Número de Telefone:</span>
        <span class="value">{{ user.phone_number }}</span>
    </div>
    
    {# NOVO BLOCO: Botões de Acesso Rápido - Vertical e Personalizado #}
    <div class="vertical-access-buttons">
        
        {# Botão: Dados Bancários - É um botão/tab, não um link #}
        <button class="vertical-button tab-button active" onclick="openTab(event, 'bank-tab')">
            <i class="fas fa-wallet"></i>
            <span>Dados Bancários</span>
            <i class="fas fa-chevron-right arrow-icon"></i>
        </button>
        
        {# Botão: Alterar Senha - É um botão/tab, não um link #}
        <button class="vertical-button tab-button" onclick="openTab(event, 'password-tab')">
            <i class="fas fa-key"></i>
            <span>Alterar Senha</span>
            <i class="fas fa-chevron-right arrow-icon"></i>
        </button>
        
        {# Botão: Nível - Link de navegação #}
        <a href="{% url 'nivel' %}" class="vertical-button">
            <i class="fas fa-trophy"></i>
            <span>Nível</span>
            <i class="fas fa-chevron-right arrow-icon"></i>
        </a>
        
        {# Botão: Equipa - Link de navegação #}
        <a href="{% url 'equipa' %}" class="vertical-button">
            <i class="fas fa-user-friends"></i>
            <span>Equipa</span>
            <i class="fas fa-chevron-right arrow-icon"></i>
        </a>
    </div>
    {# FIM DO NOVO BLOCO #}

    <div class="profile-container">
        
        {# A ABA 'info-tab' (Informações da Conta) FOI REMOVIDA CONFORME SOLICITADO. #}
        
        {# Conteúdo da Aba/Botão Dados Bancários #}
        <div id="bank-tab" class="tab-content active">
            <h3>Dados para Saque</h3>
            <form method="post" class="form-style">
                {% csrf_token %}
                <div class="form-group">
                    <label for="{{ form.account_holder_name.id_for_label }}">Nome Completo:</label>
                    {{ form.account_holder_name }}
                    {% if form.account_holder_name.errors %}
                        <ul class="errorlist">
                            {% for error in form.account_holder_name.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.bank_name.id_for_label }}">Nome do Banco:</label>
                    {{ form.bank_name }}
                    {% if form.bank_name.errors %}
                        <ul class="errorlist">
                            {% for error in form.bank_name.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.IBAN.id_for_label }}">IBAN:</label>
                    {{ form.IBAN }}
                    {% if form.IBAN.errors %}
                        <ul class="errorlist">
                            {% for error in form.IBAN.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
                <button type="submit" name="update_bank" class="submit-button">Salvar Dados Bancários</button>
            </form>
        </div>
        
        {# CONTEÚDO DA ABA/BOTÃO ALTERAR SENHA #}
        <div id="password-tab" class="tab-content">
            <h3>Alterar Senha</h3>
            <form method="post" class="form-style">
                {% csrf_token %}
                <div class="form-group">
                    <label for="{{ password_form.old_password.id_for_label }}">Senha Antiga:</label>
                    {{ password_form.old_password }}
                </div>
                <div class="form-group">
                    <label for="{{ password_form.new_password1.id_for_label }}">Nova Senha:</label>
                    {{ password_form.new_password1 }}
                </div>
                <div class="form-group">
                    <label for="{{ password_form.new_password2.id_for_label }}">Confirme a Nova Senha:</label>
                    {{ password_form.new_password2 }}
                </div>
                <button type="submit" name="change_password" class="submit-button change-password-button">Alterar Senha</button>
            </form>
        </div>
        {# FIM CONTEÚDO SENHA #}
    </div>
    
    {# BOTÃO SAIR ESTILIZADO FORA DO PROFILE-CONTAINER #}
    <div class="logout-link-container">
        <a href="{% url 'logout' %}" class="profile-action-button logout-button">
            <i class="fas fa-power-off"></i> Sair
        </a>
    </div>
</div>

<style>
    /* Inclua esta linha no seu `base.html` ou em um CSS global se possível */
    @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css');

    /* GARANTE QUE O RODAPÉ É REMOVIDO */
    footer, nav.footer-menu { 
        display: none !important; 
    }
    
    /* FUNDO BRANCO - Aplica-se ao corpo da página */
    body {
        background-color: #f0f2f5 !important; /* Fundo cinza claro ou branco */
    }

    .page-container {
        padding: 15px;
        max-width: 450px; /* Limita largura para melhor visualização móvel */
        margin: 0 auto;
        background-color: #ffffff; /* Fundo do container principal branco */
        min-height: 100vh; /* Opcional: para cobrir toda a altura */
    }
    
    /* ESTILOS DO CABEÇALHO */
    .page-header {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center; /* Centraliza o título */
        background-color: #007bff; /* Cor primária mais atraente */
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        min-height: 50px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    .page-header h1 {
        color: #fff; /* Título branco */
        margin: 0;
        font-family: 'Arial', sans-serif;
        font-size: 1.8rem;
        font-weight: 700;
    }
    
    /* NOVO ESTILO PARA O NÚMERO DE TELEFONE NO TOPO */
    .top-info-phone {
        display: flex;
        justify-content: space-between;
        padding: 15px;
        margin-bottom: 20px;
        background-color: #e9f5ff; /* Fundo azul muito claro */
        border: 1px solid #cce5ff;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .top-info-phone .label {
        color: #007bff;
    }
    .top-info-phone .value {
        color: #212529;
    }


    /* ESTILOS DOS NOVOS BOTÕES VERTICAIS (LINKS DE NAVEGAÇÃO) */
    .vertical-access-buttons {
        display: flex;
        flex-direction: column; /* Organiza em coluna */
        gap: 10px; /* Espaçamento entre os botões */
        margin-bottom: 20px;
        padding: 10px;
        background-color: #ffffff; /* Fundo branco para o bloco de botões */
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    .vertical-button {
        display: flex;
        align-items: center;
        background-color: #f8f9fa; /* Fundo do botão: Cinza muito claro */
        border: 1px solid #dee2e6;
        padding: 15px;
        border-radius: 8px;
        text-decoration: none;
        color: #343a40; /* Texto escuro */
        font-weight: 600;
        font-size: 1rem;
        transition: background-color 0.3s, box-shadow 0.3s;
        width: 100%;
        box-sizing: border-box;
        text-align: left;
        cursor: pointer;
    }
    .vertical-button:hover {
        background-color: #e9ecef;
        box-shadow: 0 0 10px rgba(0, 123, 255, 0.3);
    }
    .vertical-button i {
        font-size: 1.4rem;
        margin-right: 15px;
        color: #007bff; /* Cor dos ícones: Azul primário */
    }
    .vertical-button span {
        flex-grow: 1;
    }
    .arrow-icon {
        color: #6c757d !important; /* Seta cinza */
        font-size: 1.1rem !important;
        margin-right: 0 !important;
    }
    /* Estilo para botão de aba ativo */
    .vertical-button.active {
        background-color: #007bff;
        color: #fff; /* Texto branco no botão ativo */
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.5);
        border-color: #007bff;
    }
    .vertical-button.active i {
        color: #fff; /* Ícone branco no botão ativo */
    }

    /* ESTILOS DO CONTEÚDO OCULTÁVEL (tab-content) */
    .profile-container {
        background-color: #ffffff; /* Fundo do container de conteúdo branco */
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
        max-width: 450px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        border: 1px solid #dee2e6; /* Borda clara */
    }
    .tab-content {
        display: none;
        padding-top: 10px;
        margin-top: 15px;
    }
    .tab-content.active {
        display: block;
    }
    /* Adicione um estilo para os títulos dentro das abas */
    .tab-content h3 {
        color: #007bff; /* Título azul primário */
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 8px;
        margin-bottom: 20px;
        font-size: 1.4rem;
        font-weight: 600;
    }
    
    /* Estilos de Formulário */
    .form-style .form-group {
        margin-bottom: 15px;
    }
    .form-style label {
        display: block;
        margin-bottom: 8px;
        color: #495057;
        font-family: 'Arial', sans-serif;
        font-weight: 500;
    }
    .form-style input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ced4da;
        background-color: #f8f9fa; /* Fundo do input cinza claro */
        color: #212529;
        border-radius: 5px;
        box-sizing: border-box;
        font-size: 1rem;
        transition: border-color 0.3s;
    }
    .form-style input:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        outline: none;
    }

    /* Estilos de Botão de Submissão */
    .submit-button {
        display: block;
        width: 100%;
        padding: 14px;
        text-align: center;
        margin-top: 20px;
        text-decoration: none;
        color: #fff;
        border-radius: 8px;
        transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
        cursor: pointer;
        border: none;
        font-size: 1.1rem;
        font-weight: bold;
        background-color: #28a745; /* Cor de sucesso (Verde) */
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.4);
    }
    .submit-button:hover {
        background-color: #218838;
        transform: translateY(-1px);
        box-shadow: 0 6px 12px rgba(40, 167, 69, 0.6);
    }
    .change-password-button {
        background-color: #ffc107; /* Cor de alerta (Amarelo/Laranja) */
        color: #343a40;
        box-shadow: 0 4px 8px rgba(255, 193, 7, 0.4);
    }
    .change-password-button:hover {
        background-color: #e0a800;
        box-shadow: 0 6px 12px rgba(255, 193, 7, 0.6);
    }
    
    /* Estilo do Botão Sair - NOVO E ESTILIZADO */
    .logout-link-container {
        margin-top: 30px; /* Mais espaço acima */
        padding-top: 0;
        border-top: none;
        text-align: center;
    }
    .logout-button {
        display: flex; /* Para alinhar o ícone e o texto */
        align-items: center;
        justify-content: center;
        background-color: #dc3545; /* Cor de perigo (Vermelho) */
        border: none;
        box-shadow: 0 0 10px rgba(220, 53, 69, 0.5); 
        transition: box-shadow 0.4s ease, transform 0.3s ease;
        padding: 14px 20px; /* Um pouco maior */
        font-weight: bold;
        text-decoration: none;
        color: #fff;
        border-radius: 8px;
        width: 100%;
        box-sizing: border-box;
        font-size: 1.1rem;
        letter-spacing: 0.5px;
    }
    .logout-button i {
        margin-right: 10px; /* Espaço entre o ícone e o texto */
        font-size: 1.3rem;
    }
    .logout-button:hover {
        background-color: #c82333;
        box-shadow: 0 0 20px rgba(220, 53, 69, 0.8); 
        transform: translateY(-2px); 
    }
    
    .errorlist {
        color: #dc3545;
        list-style: none;
        padding: 0;
        margin-top: 5px;
        font-size: 0.9rem;
        font-weight: 500;
    }
</style>

<script>
    function openTab(evt, tabName) {
        var i, tabContent, tabButtons;
        
        // 1. Oculta todos os conteúdos de aba
        tabContent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabContent.length; i++) {
            tabContent[i].style.display = "none";
            tabContent[i].classList.remove("active"); // Adicionado para manter a coerência
        }
        
        // 2. Remove o estilo 'active' de todos os botões verticais
        tabButtons = document.getElementsByClassName("tab-button");
        for (i = 0; i < tabButtons.length; i++) {
            tabButtons[i].classList.remove("active");
        }

        // 3. Exibe o conteúdo da aba clicada
        const targetTab = document.getElementById(tabName);
        if (targetTab) {
            // Alterna o estado da aba
            if (targetTab.style.display === "block") {
                // Se já estiver aberto, esconde
                targetTab.style.display = "none";
                evt.currentTarget.classList.remove("active");
                localStorage.removeItem('activeTab');
            } else {
                // Caso contrário, mostra o conteúdo e ativa o botão
                targetTab.style.display = "block";
                evt.currentTarget.classList.add("active");
                targetTab.classList.add("active");
                localStorage.setItem('activeTab', tabName);
            }
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        const urlParams = new URLSearchParams(window.location.search);
        // O padrão agora é 'bank-tab', já que é a primeira aba restante
        let activeTab = urlParams.get('tab') || localStorage.getItem('activeTab') || 'bank-tab'; 

        // Se houver erros de formulário, força a abertura da aba correta
        const bankErrors = document.querySelector('#bank-tab .errorlist');
        const passwordErrors = document.querySelector('#password-tab .errorlist');
        
        if (bankErrors) {
            activeTab = 'bank-tab';
        } else if (passwordErrors) {
            activeTab = 'password-tab';
        }
        
        // 1. Garante que todos os conteúdos estejam ocultos
        const allTabContents = document.getElementsByClassName('tab-content');
        for (let i = 0; i < allTabContents.length; i++) {
            allTabContents[i].style.display = 'none';
            allTabContents[i].classList.remove('active');
        }
        // 2. Garante que todos os botões estejam inativos
        const allTabButtons = document.getElementsByClassName("tab-button");
        for (let i = 0; i < allTabButtons.length; i++) {
            allTabButtons[i].classList.remove('active');
        }

        // 3. Ativa o botão e mostra a aba
        const tabToOpen = document.getElementById(activeTab);
        const activeTabButton = document.querySelector(`.vertical-button.tab-button[onclick*="'${activeTab}'"]`); 
        
        if (tabToOpen && activeTabButton) {
            tabToOpen.style.display = 'block';
            tabToOpen.classList.add('active');
            activeTabButton.classList.add('active');
        }
    });
</script>
{% endblock %}
