{% extends "base.html" %}
{% load static %}

{% block title %}Roleta da Sorte{% endblock %}

{% block content %}
<div class="page-header professional-header">
    <h1>üé∞ Roleta da Sorte</h1>
</div>

<div class="roulette-container">
    <div class="info-section">
        <p class="lead-text">Gire a roleta e ganhe pr√©mios!</p>
        <p class="spins-counter">Giros dispon√≠veis: <span id="roulette-spins" class="badge-spins">{{ roulette_spins }}</span></p>
    </div>
    
    {% csrf_token %}

    <div class="roulette-game-area">
        <div class="pointer-indicator"></div>
        <div class="roulette-wheel-wrapper">
            <img id="roulette-wheel" src="{% static 'images/roulette_wheel.png' %}" alt="Roleta da Sorte" class="roulette-wheel">
        </div>
    </div>

    <button type="button" class="spin-button" id="spin-button" {% if not roulette_spins or roulette_spins <= 0 %}disabled{% endif %}>GIRAR AGORA</button>
    
    <div class="roulette-result" id="roulette-result"></div>
</div>

<div id="prize-modal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <div class="prize-display">
            <span class="star-icon">‚≠êÔ∏è</span>
            <h2 class="prize-title">PARAB√âNS! VOC√ä GANHOU!</h2>
            <p id="modal-prize-amount" class="prize-amount"></p>
            <p class="prize-message">O valor foi adicionado ao seu saldo de subs√≠dios e saldo ativo.</p>
        </div>
    </div>
</div>

<style>
    /* Estilos Globais da Base (Adapta√ß√£o ao Tema Branco) */
    .page-header.professional-header {
        text-align: center;
        padding: 15px 0;
        /* Fundo branco como o resto da interface */
        background-color: #FFFFFF; 
        border-bottom: 3px solid #00A65A; /* Cor de destaque/verde */
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .page-header h1 {
        color: #00004d; /* Azul Escuro */
        font-size: 1.8rem;
    }

    /* Container Principal */
    .roulette-container {
        background-color: #FFFFFF; /* Fundo Branco */
        border: 1px solid #ddd;
        padding: 30px 20px;
        border-radius: 12px;
        margin: 20px auto;
        max-width: 450px;
        text-align: center;
        color: #333; /* Texto escuro */
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    /* Info Section */
    .info-section {
        margin-bottom: 20px;
    }
    .lead-text {
        font-size: 1.1rem;
        font-weight: 500;
        color: #00004d;
    }
    .spins-counter {
        font-size: 1.0rem;
        font-weight: 400;
        margin-top: 5px;
    }
    .badge-spins {
        background-color: #FFC107; /* Amarelo (Dourado) */
        color: #000;
        padding: 5px 10px;
        border-radius: 5px;
        font-weight: bold;
        display: inline-block;
        min-width: 30px;
        text-align: center;
    }

    /* √Årea do Jogo (Roda) */
    .roulette-game-area {
        position: relative;
        width: 100%;
        max-width: 320px;
        margin: 20px auto 40px;
    }
    .roulette-wheel-wrapper {
        position: relative;
        width: 100%;
        padding-top: 100%; /* Mant√©m propor√ß√£o 1:1 */
    }
    .roulette-wheel {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 8px solid #00A65A; /* Borda da Roleta */
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        /* Transi√ß√£o mais suave e com elasticidade */
        transition: transform 6s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
    }
    .pointer-indicator {
        position: absolute;
        top: -15px; /* Posi√ß√£o acima da roda */
        left: 50%;
        transform: translateX(-50%);
        width: 0; 
        height: 0; 
        border-left: 15px solid transparent;
        border-right: 15px solid transparent;
        border-bottom: 25px solid #E91E63; /* Cor do Ponteiro (Rosa/Vermelho) */
        z-index: 10;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }


    /* Bot√£o de Girar */
    .spin-button {
        padding: 15px 40px;
        background-color: #00A65A; /* Verde Profissional */
        color: #fff;
        border: none;
        border-radius: 30px;
        font-size: 1.3rem;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s, transform 0.2s;
        box-shadow: 0 5px 15px rgba(0, 166, 90, 0.4);
        letter-spacing: 1px;
    }
    .spin-button:hover:not(:disabled) {
        background-color: #008D4C;
        transform: translateY(-2px);
    }
    .spin-button:disabled {
        background-color: #A0A0A0;
        cursor: not-allowed;
        box-shadow: none;
    }
    
    /* Resultados (Pr√©-spin) */
    .roulette-result {
        margin-top: 30px;
        font-size: 1.2rem;
        font-weight: 600;
        color: #00004d; /* Azul Escuro */
        min-height: 25px;
    }

    /* --- Modal e Efeito Pr√™mio --- */
    .modal {
        display: none; 
        position: fixed; 
        z-index: 100; 
        left: 0;
        top: 0;
        width: 100%; 
        height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.7); 
        padding-top: 60px;
    }

    .modal-content {
        background-color: #fff;
        margin: 5% auto; 
        padding: 30px;
        border-radius: 15px;
        width: 90%; 
        max-width: 400px;
        text-align: center;
        position: relative;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
        border: 5px solid #FFD700; /* Borda Dourada */
        /* Efeito de luz (anima√ß√£o de brilho suave) */
        animation: glow 1.5s infinite alternate;
    }
    
    @keyframes glow {
        from {
            box-shadow: 0 0 10px #FFD700, 0 0 20px #FFC107;
        }
        to {
            box-shadow: 0 0 20px #FFD700, 0 0 40px #FFC107;
        }
    }

    .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        position: absolute;
        top: 10px;
        right: 20px;
    }

    .close-button:hover,
    .close-button:focus {
        color: #E91E63;
        text-decoration: none;
        cursor: pointer;
    }
    
    .prize-display {
        margin-top: 10px;
    }

    .star-icon {
        font-size: 3rem;
        display: block;
        margin-bottom: 10px;
        animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    .prize-title {
        color: #00A65A;
        font-size: 1.5rem;
        margin-bottom: 10px;
    }

    .prize-amount {
        font-size: 2.5rem;
        font-weight: 800;
        color: #00004d;
        margin-top: 10px;
    }

    .prize-message {
        color: #666;
        font-size: 0.9rem;
        margin-top: 15px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const spinButton = document.getElementById('spin-button');
        const rouletteWheel = document.getElementById('roulette-wheel');
        const resultDisplay = document.getElementById('roulette-result');
        const spinsDisplay = document.getElementById('roulette-spins');
        const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

        // Modal elements
        const prizeModal = document.getElementById('prize-modal');
        const modalPrizeAmount = document.getElementById('modal-prize-amount');
        const closeModal = document.querySelector('.close-button');

        // Close modal functions
        closeModal.onclick = function() {
            prizeModal.style.display = 'none';
        }
        window.onclick = function(event) {
            if (event.target == prizeModal) {
                prizeModal.style.display = 'none';
            }
        }
        
        if (spinButton && rouletteWheel) {
            spinButton.addEventListener('click', function() {
                spinButton.disabled = true;
                resultDisplay.textContent = 'Girando... Aguarde o resultado...';
                rouletteWheel.style.transition = 'transform 6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                // Gira a roda um n√∫mero aleat√≥rio de vezes para dar o efeito de spin
                rouletteWheel.style.transform = `rotate(3600deg)`;

                fetch('{% url "spin_roulette" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const prize = parseFloat(data.prize);
                        // L√≥gica para calcular os graus necess√°rios para que o pr√™mio caia em um setor espec√≠fico.
                        // (Isso depende da sua imagem 'roulette_wheel.png' e da ordem dos pr√™mios)
                        // Para fins de demonstra√ß√£o, vamos apenas adicionar mais rota√ß√£o aleat√≥ria.
                        const extraDegrees = Math.floor(Math.random() * 360) + 720; // 2 voltas extras + 0-360
                        
                        // Garante que a transi√ß√£o seja redefinida para a rota√ß√£o final
                        rouletteWheel.style.transition = 'transform 6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                        rouletteWheel.style.transform = `rotate(${3600 + extraDegrees}deg)`;

                        setTimeout(() => {
                            // 1. Exibir Modal de Pr√™mio
                            modalPrizeAmount.textContent = `${prize.toFixed(2)} KZ`;
                            prizeModal.style.display = 'block';

                            // 2. Atualizar contagem e resultado no painel
                            resultDisplay.textContent = `Voc√™ ganhou ${prize.toFixed(2)} KZ!`;
                            spinsDisplay.textContent = parseInt(spinsDisplay.textContent) - 1;
                            
                            // 3. Reativar o bot√£o (e desativar se os giros acabaram)
                            const remainingSpins = parseInt(spinsDisplay.textContent);
                            if (remainingSpins > 0) {
                                spinButton.disabled = false;
                            } else {
                                spinButton.disabled = true;
                            }
                        }, 6000); // Espera 6 segundos para a transi√ß√£o terminar
                    } else {
                        resultDisplay.textContent = data.message;
                        spinButton.disabled = false;
                        // Resetar a rota√ß√£o se for uma falha imediata
                        rouletteWheel.style.transform = `rotate(0deg)`;
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    resultDisplay.textContent = 'Ocorreu um erro ao girar a roleta. Tente novamente.';
                    spinButton.disabled = false;
                    rouletteWheel.style.transform = `rotate(0deg)`;
                });
            });
        }
    });
</script>
{% endblock %}
