{% extends "base.html" %}
{% load static %}

{% block title %}Tarefas{% endblock %}

{% block content %}
<div class="page-container">
    {# A. HEADER (MANTIDO, AJUSTE DE TEMA PARA FAZENDA) #}
    <div class="page-header farm-header">
        <h1>Tarefas Diárias</h1>
    </div>

    {% if not has_active_level %}
    {# B. INSTRUÇÕES PARA NÍVEL INATIVO #}
    <div class="sub-section">
            <div class="full-width-image-container">
                {# Mudança na imagem: Usando uma imagem de fazenda #}
                <img src="{% static 'images/cattle_empty.png' %}" alt="Instruções Imagem principal" class="full-width-image">
            </div>
            <div class="header">
                <h2>Instruções</h2>
            </div>

        <div class="info-box-danger farm-alert">
            <p>O SEU CURRAL DE ALIMENTAÇÃO ESTÁ VAZIO, COMPRE GADO</p>
        </div>
    {% else %}
        
        {# C. IMAGEM DE TOPO (BANNER) #}
        {# Usando o banner da imagem que você forneceu: image_0c8b3f.png #}
        <div class="cattle-image-top-container">
            <img src="{% static 'images/refinaria_banner.jpg' %}" alt="Curral de Gado" class="cattle-banner-image">
        </div>

        {# D. CONTAINER PRINCIPAL DA TAREFA (POSTO DE ALIMENTAÇÃO) #}
        <div class="task-machine-container farm-style">
            
            <div class="feeding-station-visual">
                <i class="fa-solid fa-cow cattle-icon"></i>
                <div class="feed-trough"></div>
            </div>

            <div class="machine-screen farm-screen">
                <p id="task-message">Clique no botão abaixo para trabalhar e gerar seu ganho diário!</p>
            </div>

            <div class="machine-body farm-body">
                <div class="machine-light-container farm-lights">
                    <div class="machine-light red-light" id="light-red"></div>
                    <div class="machine-light yellow-light" id="light-yellow"></div>
                    <div class="machine-light green-light" id="light-green"></div>
                </div>
                
                {# BOTÃO DE AÇÃO: MUDADO PARA ALIMENTAR #}
                <button id="work-button" class="work-button feed-button">ALIMENTAR</button>
            </div>
        </div>

        {# E. MENSAGENS E LÓGICA DJANGO (MANTIDA) #}
        {% if messages %}
            <ul class="messages">
                {% for message in messages %}
                    <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}

        {# F. INFORMAÇÕES DE NÍVEL E TAREFAS (REMOVIDAS, mas a variável JS é mantida para a lógica) #}
        {# REMOVIDO: <div class="tasks-info"> ... </div> #}
        
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const workButton = document.getElementById('work-button');
                const taskMessage = document.getElementById('task-message');
                
                // Elementos de luzes
                const lightRed = document.getElementById('light-red');
                const lightYellow = document.getElementById('light-yellow');
                const lightGreen = document.getElementById('light-green');

                // Variáveis do Django para JS (LÓGICA MANTIDA)
                let tasksCompletedToday = {{ tasks_completed_today|default:0 }}; 
                let maxTasks = {{ max_tasks|default:1 }};

                function updateLightStatus(isWorking = false) {
                    lightRed.classList.remove('active', 'blinking');
                    lightYellow.classList.remove('active', 'blinking');
                    lightGreen.classList.remove('active', 'blinking');

                    const tasksRemaining = maxTasks - tasksCompletedToday;

                    if (isWorking) {
                        // Estado de processamento (Amarelo)
                        lightYellow.classList.add('blinking');
                        workButton.textContent = "ALIMENTANDO...";
                    } else if (tasksRemaining > 0) {
                        // Pronto para trabalhar (Vermelho Pisca)
                        lightRed.classList.add('blinking');
                        workButton.textContent = "ALIMENTAR";
                    } else {
                        // Tarefas concluídas (Verde Aceso)
                        lightGreen.classList.add('active');
                        workButton.textContent = "CONCLUÍDO";
                    }
                }

                function checkTasksStatus() {
                    const tasksRemaining = maxTasks - tasksCompletedToday;

                    if (tasksRemaining <= 0) {
                        if (workButton) {
                            workButton.disabled = true;
                            taskMessage.textContent = "Seu gado está satisfeito! Tarefas diárias concluídas.";
                        }
                    } else {
                         if (workButton) {
                            workButton.disabled = false;
                            taskMessage.textContent = "Clique no botão abaixo para alimentar seu gado e gerar seu ganho diário!";
                        }
                    }
                    
                    // A Span tasksRemainingSpan foi removida do HTML, mas a lógica de status da luz permanece.
                    updateLightStatus();
                }
        
                if (workButton) {
                    workButton.addEventListener('click', function() {
                        if (tasksCompletedToday < maxTasks) {
                            workButton.disabled = true;
                            taskMessage.textContent = "Preenchendo o Curral com Ração... aguarde.";
                            updateLightStatus(true); // Ativa o estado de processamento

                            // REQUISIÇÃO AJAX MANTIDA EXATAMENTE COMO ESTAVA
                            fetch("{% url 'process_task' %}", {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                }
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    tasksCompletedToday++;
                                    // MENSAGEM DE SUCESSO PERSONALIZADA
                                    taskMessage.textContent = `Gado alimentado com sucesso! Ganho diário: KZ ${data.daily_gain}.`;
                                } else {
                                    taskMessage.textContent = data.message || "Ocorreu um erro ao alimentar o gado.";
                                }
                                checkTasksStatus();
                                workButton.disabled = (maxTasks - tasksCompletedToday <= 0);
                            })
                            .catch(error => {
                                console.error('Erro:', error);
                                taskMessage.textContent = "Erro na comunicação com o servidor.";
                                checkTasksStatus();
                            });
                        }
                    });
                }
                checkTasksStatus();
            });
        </script>
    {% endif %}
</div>

<style>
    /* ------------------------------------ */
    /* NOVO DESIGN: FAZENDA E ALIMENTAÇÃO */
    /* ------------------------------------ */
    
    .page-container {
        padding: 15px;
        background-color: #ffffff; /* Fundo Branco */
    }

    /* Cabeçalho */
    .farm-header {
        background-color: #ffffff; 
        padding: 10px 0;
        text-align: center;
        border-bottom: 3px solid #4CAF50; /* Borda verde da fazenda */
    }
    .farm-header h1 {
        color: #0d1a2f; /* Cor escura */
        text-shadow: none;
        font-weight: 800;
        font-size: 1.8rem;
        margin: 0;
    }
    
    /* Imagem de Topo (Banner) */
    .cattle-image-top-container {
        margin: -15px -15px 20px -15px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        border-bottom: 5px solid #4CAF50;
    }
    .cattle-banner-image {
        width: 100%;
        height: 180px;
        object-fit: cover;
        filter: none; /* Imagem nítida */
    }

    /* Alerta de Nível Inativo */
    .farm-alert {
        background-color: #fff8e1; /* Amarelo claro suave */
        color: #e65100; /* Laranja da ração */
        border: 2px solid #ffb300;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .farm-alert p {
        margin: 5px 0;
        line-height: 1.4;
        font-size: 0.9rem;
    }


    /* Container Principal da Tarefa (Estilo Fazenda) */
    .task-machine-container.farm-style {
        background: #f0f4f7; /* Cinza claro */
        border: 4px solid #b3884e; /* Marrom da madeira/curral */
        border-radius: 15px;
        max-width: 400px;
        margin: 0 auto;
        padding: 10px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.15), inset 0 0 10px rgba(255, 255, 255, 0.8);
    }

    /* Visual do Curral/Gado */
    .feeding-station-visual {
        text-align: center;
        padding: 15px 0;
        position: relative;
    }
    .cattle-icon {
        font-size: 4rem;
        color: #b3884e; /* Cor marrom */
        text-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        margin-bottom: 10px;
        display: block;
    }
    .feed-trough {
        width: 80%;
        height: 10px;
        background-color: #8d6e63; /* Cocho de alimentação marrom */
        border-radius: 5px;
        margin: 0 auto;
        box-shadow: inset 0 3px 5px rgba(0,0,0,0.3);
        position: relative;
    }

    /* Tela de Status */
    .machine-screen.farm-screen {
        background-color: #0d1a2f; /* Fundo azul escuro */
        color: #ffffff; 
        border: 2px solid #4CAF50; /* Borda verde */
        box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        min-height: 80px;
        padding: 15px;
        border-radius: 8px;
    }
    .machine-screen p {
        font-size: 1.1rem;
        text-shadow: none;
        color: #FFC300; /* Dourado/Amarelo para mensagem */
        font-weight: 600;
    }

    /* Corpo da Máquina e Luzes */
    .machine-body.farm-body {
        padding: 20px 0 10px 0;
        text-align: center;
    }

    /* Luzes de Status */
    .machine-light-container.farm-lights {
        margin-bottom: 25px;
        background-color: #e0e0e0; /* Cinza claro */
        border-radius: 5px;
        padding: 10px 20px;
        box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: center;
        gap: 15px;
    }
    .machine-light {
        /* Mantém as classes e animações de luzes */
        /* Cores: Vermelho=Pronto, Amarelo=Alimentando, Verde=Concluído */
    }

    /* Botão ALIMENTAR */
    .work-button.feed-button {
        background-color: #4CAF50; /* Verde da Fazenda */
        background-image: linear-gradient(to top, #4CAF50, #81C784);
        color: #fff;
        font-size: 1.4rem;
        padding: 12px 25px;
        border-radius: 50px; /* Mais arredondado */
        box-shadow: 0 6px 0 #388E3C, 0 0 15px rgba(76, 175, 80, 0.5);
        transition: all 0.1s;
    }
    .work-button.feed-button:active {
        transform: translateY(4px);
        box-shadow: 0 2px 0 #388E3C;
    }
    .work-button.feed-button:disabled {
        background-color: #a5d6a7 !important;
        background-image: none !important;
        box-shadow: 0 6px 0 #7cb342 !important;
        color: #fff;
    }
    
    /* REMOÇÃO DA SEÇÃO INFERIOR DE INFORMAÇÕES */
    .tasks-info {
        display: none; /* Remove a exibição da seção de nível/tarefas restantes */
    }
    
    /* Estilos genéricos (mantidos se estiverem em um arquivo separado) */
    .work-button {
        width: 80%;
        border: none;
        cursor: pointer;
        font-weight: bold;
        text-transform: uppercase;
    }
    
</style>
{% endblock %}
